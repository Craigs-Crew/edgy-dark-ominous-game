local S = default.get_translator

local function register_sign(material, desc, def)
	minetest.register_node("blocks:sign_wall_" .. material, {
		description = desc,
		drawtype = "nodebox",
		tiles = { "blocks_sign_wall_" .. material .. ".png" },
		inventory_image = "blocks_sign_" .. material .. ".png",
		wield_image = "blocks_sign_" .. material .. ".png",
		paramtype = "light",
		paramtype2 = "wallmounted",
		sunlight_propagates = true,
		is_ground_content = false,
		walkable = false,
		use_texture_alpha = "opaque",
		node_box = {
			type = "wallmounted",
			wall_top = { -0.4375, 0.4375, -0.3125, 0.4375, 0.5, 0.3125 },
			wall_bottom = { -0.4375, -0.5, -0.3125, 0.4375, -0.4375, 0.3125 },
			wall_side = { -0.5, -0.3125, -0.4375, -0.4375, 0.3125, 0.4375 },
		},
		groups = def.groups,
		legacy_wallmounted = true,
		sounds = def.sounds,

		on_construct = function(pos)
			local meta = minetest.get_meta(pos)
			meta:set_string("formspec", "field[text;;${text}]")
		end,
		on_receive_fields = function(pos, formname, fields, sender)
			local player_name = sender:get_player_name()
			if minetest.is_protected(pos, player_name) then
				minetest.record_protection_violation(pos, player_name)
				return
			end
			local text = fields.text
			if not text then
				return
			end
			if string.len(text) > 512 then
				minetest.chat_send_player(player_name, S("Text too long"))
				return
			end
			minetest.log(
				"action",
				player_name .. ' wrote "' .. text .. '" to the sign at ' .. minetest.pos_to_string(pos)
			)
			local meta = minetest.get_meta(pos)
			meta:set_string("text", text)

			if #text > 0 then
				meta:set_string("infotext", S('"@1"', text))
			else
				meta:set_string("infotext", "")
			end
		end,
	})
end

register_sign("wood", S("Wooden Sign"), {
	sounds = default.node_sound_wood_defaults(),
	groups = { choppy = 2, attached_node = 1, flammable = 2, oddly_breakable_by_hand = 3 },
})

register_sign("steel", S("Steel Sign"), {
	sounds = default.node_sound_metal_defaults(),
	groups = { cracky = 2, attached_node = 1 },
})

--
-- == CRAFTS
--

minetest.register_craft({
	output = "blocks:sign_wall_steel 3",
	recipe = {
		{ "blocks:steel_ingot", "blocks:steel_ingot", "blocks:steel_ingot" },
		{ "blocks:steel_ingot", "blocks:steel_ingot", "blocks:steel_ingot" },
		{ "", "group:stick", "" },
	},
})

minetest.register_craft({
	output = "blocks:sign_wall_wood 3",
	recipe = {
		{ "group:wood", "group:wood", "group:wood" },
		{ "group:wood", "group:wood", "group:wood" },
		{ "", "group:stick", "" },
	},
})

minetest.register_craft({
	type = "fuel",
	recipe = "blocks:sign_wall_wood",
	burntime = 10,
})
